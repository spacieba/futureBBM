<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syst√®me de Gestion Scolaire</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* === AVATARS ANIM√âS DES FRANCHISES === */

        /* Minotaurs - Taureau qui charge */
        .minotaur-avatar {
            display: inline-block;
            font-size: 3rem;
            animation: charge 2s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(255, 0, 0, 0.5));
        }

        @keyframes charge {
            0%, 100% { transform: translateX(0) rotate(0deg); }
            50% { transform: translateX(-3px) rotate(-2deg); }
        }

        /* Krakens - Tentacules qui ondulent */
        .kraken-avatar {
            display: inline-block;
            font-size: 3rem;
            animation: tentacles 3s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(0, 100, 255, 0.5));
        }

        @keyframes tentacles {
            0%, 100% { transform: rotate(0deg) scale(1); }
            33% { transform: rotate(2deg) scale(1.05); }
            66% { transform: rotate(-2deg) scale(0.95); }
        }

        /* Phoenix - Flammes qui dansent */
        .phoenix-avatar {
            display: inline-block;
            font-size: 3rem;
            animation: flames 2s ease-in-out infinite;
            filter: drop-shadow(0 0 15px rgba(255, 165, 0, 0.7));
        }

        @keyframes flames {
            0%, 100% { transform: translateY(0px) scale(1); }
            25% { transform: translateY(-2px) scale(1.1); }
            75% { transform: translateY(1px) scale(0.9); }
        }

        /* Werewolves - Yeux qui brillent */
        .werewolf-avatar {
            display: inline-block;
            font-size: 3rem;
            animation: glow 4s ease-in-out infinite;
            filter: drop-shadow(0 0 10px rgba(0, 255, 0, 0.4));
        }

        @keyframes glow {
            0%, 100% { filter: drop-shadow(0 0 10px rgba(0, 255, 0, 0.4)); }
            50% { filter: drop-shadow(0 0 20px rgba(0, 255, 0, 0.8)) brightness(1.2); }
        }

        /* Effet de hover pour tous les avatars */
        .franchise-avatar:hover {
            transform: scale(1.2);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        /* Particules de fond optionnelles */
        .franchise-card {
            position: relative;
            overflow: hidden;
        }

        .franchise-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: sparkle 10s linear infinite;
            pointer-events: none;
        }

        @keyframes sparkle {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(-20px, -20px) rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        // ================================
// PHASE 1 - INFRASTRUCTURE BADGES
// ================================

// ========================================
// 1. D√âFINITIONS DES BADGES ET CONDITIONS
// ========================================

const BADGE_DEFINITIONS = {
  // BADGES INDIVIDUELS
  individual: {
    // S√©ries
    'hot_streak': {
      name: 'Hot Streak',
      emoji: 'üî•',
      description: '5 actions positives d\'affil√©e',
      rarity: 'bronze',
      points_bonus: 5,
      condition: 'consecutive_positive_actions',
      threshold: 5
    },
    'tsunami': {
      name: 'Tsunami',
      emoji: 'üåä',
      description: '10 actions positives d\'affil√©e',
      rarity: 'silver',
      points_bonus: 10,
      condition: 'consecutive_positive_actions',
      threshold: 10
    },
    'unstoppable': {
      name: 'Unstoppable',
      emoji: 'üöÄ',
      description: '15 actions positives d\'affil√©e',
      rarity: 'gold',
      points_bonus: 20,
      condition: 'consecutive_positive_actions',
      threshold: 15
    },
    'on_fire': {
      name: 'On Fire',
      emoji: 'üî•',
      description: '2 "Hardworker" (6pts) en 2 semaines',
      rarity: 'silver',
      points_bonus: 10,
      condition: 'hardworker_streak',
      threshold: 2,
      timeframe: 14 // jours
    },
    
    // Pers√©v√©rance
    'phoenix': {
      name: 'Phoenix',
      emoji: 'ü¶Ö',
      description: 'Remonter de -50 √† +50 points',
      rarity: 'gold',
      points_bonus: 20,
      condition: 'score_recovery',
      from: -50,
      to: 50
    },
    'marathon_runner': {
      name: 'Marathon Runner',
      emoji: 'üèÉ',
      description: 'Actions positives 5 jours d\'√©cole cons√©cutifs',
      rarity: 'bronze',
      points_bonus: 5,
      condition: 'consecutive_days_positive',
      threshold: 5
    },
    
    // Sociaux/√âquipe
    'team_captain': {
      name: 'Team Captain',
      emoji: 'üëë',
      description: 'Meilleur de sa franchise pendant 1 semaine',
      rarity: 'silver',
      points_bonus: 10,
      condition: 'franchise_leader',
      duration: 7 // jours
    },
    'veteran': {
      name: 'Veteran',
      emoji: 'üéñÔ∏è',
      description: 'Top 3 de sa franchise pendant 2 mois',
      rarity: 'gold',
      points_bonus: 20,
      condition: 'franchise_top3',
      duration: 60 // jours
    },
    'team_player': {
      name: 'Team Player',
      emoji: 'ü§ù',
      description: 'Sa franchise gagne le + de points en 1 semaine',
      rarity: 'bronze',
      points_bonus: 5,
      condition: 'franchise_best_week',
      duration: 7
    },
    
    // Sp√©ciaux & Rares
    'showtime': {
      name: 'Showtime',
      emoji: 'üé™',
      description: 'Recevoir "F√©licitations" (25pts) 3 fois',
      rarity: 'diamond',
      points_bonus: 35,
      condition: 'congratulations_count',
      threshold: 3
    }
  },
  
  // BADGES COLLECTIFS
  collective: {
    // Performances
    'rocket_launch': {
      name: 'Rocket Launch',
      emoji: 'üöÄ',
      description: '+80 points collectifs en 1 semaine',
      rarity: 'bronze',
      franchise_points: 20,
      condition: 'franchise_weekly_points',
      threshold: 80
    },
    'tidal_wave': {
      name: 'Tidal Wave',
      emoji: 'üåä',
      description: '+200 points collectifs en 1 mois',
      rarity: 'gold',
      franchise_points: 50,
      condition: 'franchise_monthly_points',
      threshold: 200
    },
    'lightning_strike': {
      name: 'Lightning Strike',
      emoji: '‚ö°',
      description: 'Tous les membres gagnent points m√™me jour',
      rarity: 'bronze',
      franchise_points: 20,
      condition: 'all_members_positive_day'
    },
    'house_on_fire': {
      name: 'House on Fire',
      emoji: 'üî•',
      description: '80% membres actions positives en 1 semaine',
      rarity: 'silver',
      franchise_points: 30,
      condition: 'franchise_participation',
      threshold: 0.8,
      duration: 7
    },
    
    // Supr√©matie
    'franchise_royalty': {
      name: 'Franchise Royalty',
      emoji: 'üëë',
      description: '#1 pendant 1 mois complet',
      rarity: 'silver',
      franchise_points: 50,
      condition: 'franchise_rank_duration',
      rank: 1,
      duration: 30
    },
    'dynasty': {
      name: 'Dynasty',
      emoji: 'üåü',
      description: '#1 pendant 3 mois cons√©cutifs',
      rarity: 'gold',
      franchise_points: 100,
      condition: 'franchise_rank_duration',
      rank: 1,
      duration: 90
    },
    
    // Solidarit√©
    'united_we_stand': {
      name: 'United We Stand',
      emoji: 'ü§ù',
      description: 'Aucun membre n√©gatif pendant 2 semaines',
      rarity: 'silver',
      franchise_points: 30,
      condition: 'no_negative_members',
      duration: 14
    },
    'perfect_balance': {
      name: 'Perfect Balance',
      emoji: '‚öñÔ∏è',
      description: 'Tous membres entre 25-75 points',
      rarity: 'gold',
      franchise_points: 50,
      condition: 'score_range_all',
      min: 25,
      max: 75
    }
  }
};

// =============================================
// 2. STRUCTURE DE DONN√âES POUR LE STOCKAGE
// =============================================

// Structure pour stocker les badges en m√©moire (√† adapter selon votre backend)
let BADGE_STORAGE = {
  // Badges individuels : { playerName: [{ badgeId, dateEarned, conditions }, ...] }
  individual: {},
  
  // Badges collectifs : { franchise: [{ badgeId, dateEarned, conditions }, ...] }
  collective: {},
  
  // Tracking des actions pour calculs
  actionHistory: {},
  
  // Tracking des statistiques temporelles
  weeklyStats: {},
  monthlyStats: {},
  streaks: {}
};

// ==============================================
// 3. FONCTIONS DE TRACKING DES ACTIONS
// ==============================================

/**
 * Enregistrer une action et mettre √† jour les statistiques
 */
function trackAction(playerName, points, action, timestamp = new Date()) {
  const dateKey = timestamp.toISOString().split('T')[0]; // YYYY-MM-DD
  
  // Initialiser si n√©cessaire
  if (!BADGE_STORAGE.actionHistory[playerName]) {
    BADGE_STORAGE.actionHistory[playerName] = [];
  }
  
  // Ajouter l'action
  const actionEntry = {
    points,
    action,
    timestamp,
    dateKey,
    isPositive: points > 0
  };
  
  BADGE_STORAGE.actionHistory[playerName].push(actionEntry);
  
  // Mettre √† jour les streaks
  updateStreaks(playerName, actionEntry);
  
  // Mettre √† jour les statistiques temporelles
  updateTemporalStats(playerName, actionEntry);
  
  console.log(`üîç Action track√©e pour ${playerName}: ${action} (${points} pts)`);
}

/**
 * Mettre √† jour les streaks (s√©ries d'actions)
 */
function updateStreaks(playerName, actionEntry) {
  if (!BADGE_STORAGE.streaks[playerName]) {
    BADGE_STORAGE.streaks[playerName] = {
      currentPositiveStreak: 0,
      maxPositiveStreak: 0,
      currentNegativeStreak: 0,
      lastActionDate: null,
      consecutiveDaysPositive: 0
    };
  }
  
  const streak = BADGE_STORAGE.streaks[playerName];
  
  if (actionEntry.isPositive) {
    streak.currentPositiveStreak++;
    streak.currentNegativeStreak = 0;
    streak.maxPositiveStreak = Math.max(streak.maxPositiveStreak, streak.currentPositiveStreak);
  } else {
    streak.currentNegativeStreak++;
    streak.currentPositiveStreak = 0;
  }
  
  // Tracking des jours cons√©cutifs avec actions positives
  const today = actionEntry.dateKey;
  if (actionEntry.isPositive) {
    if (streak.lastActionDate === today) {
      // D√©j√† une action positive aujourd'hui, ne pas incr√©menter
    } else if (isConsecutiveDay(streak.lastActionDate, today)) {
      streak.consecutiveDaysPositive++;
    } else {
      streak.consecutiveDaysPositive = 1; // Restart
    }
    streak.lastActionDate = today;
  }
  
  console.log(`üìä Streak mis √† jour pour ${playerName}:`, streak);
}

/**
 * V√©rifier si deux dates sont cons√©cutives
 */
function isConsecutiveDay(lastDate, currentDate) {
  if (!lastDate) return false;
  
  const last = new Date(lastDate);
  const current = new Date(currentDate);
  const diffTime = current - last;
  const diffDays = diffTime / (1000 * 60 * 60 * 24);
  
  return diffDays === 1;
}

/**
 * Mettre √† jour les statistiques temporelles
 */
function updateTemporalStats(playerName, actionEntry) {
  const weekKey = getWeekKey(actionEntry.timestamp);
  const monthKey = getMonthKey(actionEntry.timestamp);
  
  // Stats hebdomadaires
  if (!BADGE_STORAGE.weeklyStats[weekKey]) {
    BADGE_STORAGE.weeklyStats[weekKey] = {};
  }
  if (!BADGE_STORAGE.weeklyStats[weekKey][playerName]) {
    BADGE_STORAGE.weeklyStats[weekKey][playerName] = {
      totalPoints: 0,
      positiveActions: 0,
      actions: []
    };
  }
  
  BADGE_STORAGE.weeklyStats[weekKey][playerName].totalPoints += actionEntry.points;
  if (actionEntry.isPositive) {
    BADGE_STORAGE.weeklyStats[weekKey][playerName].positiveActions++;
  }
  BADGE_STORAGE.weeklyStats[weekKey][playerName].actions.push(actionEntry);
  
  // Stats mensuelles (m√™me logique)
  if (!BADGE_STORAGE.monthlyStats[monthKey]) {
    BADGE_STORAGE.monthlyStats[monthKey] = {};
  }
  if (!BADGE_STORAGE.monthlyStats[monthKey][playerName]) {
    BADGE_STORAGE.monthlyStats[monthKey][playerName] = {
      totalPoints: 0,
      positiveActions: 0,
      actions: []
    };
  }
  
  BADGE_STORAGE.monthlyStats[monthKey][playerName].totalPoints += actionEntry.points;
  if (actionEntry.isPositive) {
    BADGE_STORAGE.monthlyStats[monthKey][playerName].positiveActions++;
  }
  BADGE_STORAGE.monthlyStats[monthKey][playerName].actions.push(actionEntry);
}

/**
 * Obtenir la cl√© de semaine (ann√©e-semaine)
 */
function getWeekKey(date) {
  const d = new Date(date);
  const yearStart = new Date(d.getFullYear(), 0, 1);
  const weekNo = Math.ceil(((d - yearStart) / 86400000 + yearStart.getDay() + 1) / 7);
  return `${d.getFullYear()}-W${weekNo}`;
}

/**
 * Obtenir la cl√© de mois (ann√©e-mois)
 */
function getMonthKey(date) {
  const d = new Date(date);
  return `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, '0')}`;
}

// ===============================================
// 4. MOTEUR DE V√âRIFICATION DES CONDITIONS
// ===============================================

/**
 * V√©rifier toutes les conditions de badges pour un joueur
 */
function checkAllBadgesForPlayer(playerName, currentScore, franchise) {
  console.log(`üéØ V√©rification badges pour ${playerName} (${currentScore} pts, ${franchise})`);
  
  const newBadges = [];
  
  // V√©rifier les badges individuels
  for (const [badgeId, badge] of Object.entries(BADGE_DEFINITIONS.individual)) {
    if (!hasPlayerBadge(playerName, badgeId)) {
      if (checkBadgeCondition(playerName, badge, currentScore, franchise)) {
        awardBadge(playerName, badgeId, badge, 'individual');
        newBadges.push({ type: 'individual', badgeId, badge });
      }
    }
  }
  
  return newBadges;
}

/**
 * V√©rifier toutes les conditions de badges pour une franchise
 */
function checkAllBadgesForFranchise(franchise, players) {
  console.log(`üè† V√©rification badges collectifs pour ${franchise}`);
  
  const newBadges = [];
  
  // V√©rifier les badges collectifs
  for (const [badgeId, badge] of Object.entries(BADGE_DEFINITIONS.collective)) {
    if (!hasFranchiseBadge(franchise, badgeId)) {
      if (checkFranchiseBadgeCondition(franchise, badge, players)) {
        awardFranchiseBadge(franchise, badgeId, badge);
        newBadges.push({ type: 'collective', badgeId, badge });
      }
    }
  }
  
  return newBadges;
}

/**
 * V√©rifier une condition sp√©cifique de badge individuel
 */
function checkBadgeCondition(playerName, badge, currentScore, franchise) {
  const streak = BADGE_STORAGE.streaks[playerName];
  if (!streak) return false;
  
  switch (badge.condition) {
    case 'consecutive_positive_actions':
      return streak.currentPositiveStreak >= badge.threshold;
      
    case 'consecutive_days_positive':
      return streak.consecutiveDaysPositive >= badge.threshold;
      
    case 'score_recovery':
      return checkScoreRecovery(playerName, badge.from, badge.to);
      
    case 'hardworker_streak':
      return checkHardworkerStreak(playerName, badge.threshold, badge.timeframe);
      
    case 'congratulations_count':
      return checkCongratulationsCount(playerName, badge.threshold);
      
    case 'franchise_leader':
      return checkFranchiseLeader(playerName, franchise, badge.duration);
      
    case 'franchise_top3':
      return checkFranchiseTop3(playerName, franchise, badge.duration);
      
    default:
      console.warn(`‚ùå Condition inconnue: ${badge.condition}`);
      return false;
  }
}

/**
 * V√©rifier une condition sp√©cifique de badge collectif
 */
function checkFranchiseBadgeCondition(franchise, badge, players) {
  switch (badge.condition) {
    case 'franchise_weekly_points':
      return checkFranchiseWeeklyPoints(franchise, badge.threshold);
      
    case 'franchise_monthly_points':
      return checkFranchiseMonthlyPoints(franchise, badge.threshold);
      
    case 'all_members_positive_day':
      return checkAllMembersPositiveToday(franchise, players);
      
    case 'franchise_participation':
      return checkFranchiseParticipation(franchise, badge.threshold, badge.duration);
      
    case 'no_negative_members':
      return checkNoNegativeMembers(franchise, players, badge.duration);
      
    case 'score_range_all':
      return checkScoreRangeAll(franchise, players, badge.min, badge.max);
      
    default:
      console.warn(`‚ùå Condition collective inconnue: ${badge.condition}`);
      return false;
  }
}

// ===============================================
// 5. FONCTIONS DE V√âRIFICATION SP√âCIFIQUES
// ===============================================

function checkScoreRecovery(playerName, fromScore, toScore) {
  const history = BADGE_STORAGE.actionHistory[playerName];
  if (!history || history.length < 2) return false;
  
  // Chercher un point o√π le score √©tait <= fromScore
  let hadLowScore = false;
  let runningTotal = 0;
  
  for (const action of history) {
    runningTotal += action.points;
    if (runningTotal <= fromScore) {
      hadLowScore = true;
    }
    if (hadLowScore && runningTotal >= toScore) {
      return true;
    }
  }
  
  return false;
}

function checkHardworkerStreak(playerName, count, timeframeDays) {
  const history = BADGE_STORAGE.actionHistory[playerName];
  if (!history) return false;
  
  const now = new Date();
  const cutoff = new Date(now.getTime() - (timeframeDays * 24 * 60 * 60 * 1000));
  
  const hardworkerActions = history.filter(action => 
    action.action === 'Hardworker' && 
    action.points === 6 && 
    action.timestamp >= cutoff
  );
  
  return hardworkerActions.length >= count;
}

function checkCongratulationsCount(playerName, count) {
  const history = BADGE_STORAGE.actionHistory[playerName];
  if (!history) return false;
  
  const congratulations = history.filter(action => 
    action.action === 'F√©licitations' && action.points === 25
  );
  
  return congratulations.length >= count;
}

function checkFranchiseWeeklyPoints(franchise, threshold) {
  const weekKey = getWeekKey(new Date());
  const weekStats = BADGE_STORAGE.weeklyStats[weekKey];
  if (!weekStats) return false;
  
  let franchiseTotal = 0;
  for (const [playerName, stats] of Object.entries(weekStats)) {
    // Note: Il faudrait avoir acc√®s √† la franchise du joueur ici
    // Pour l'instant, on simplifie
    franchiseTotal += stats.totalPoints;
  }
  
  return franchiseTotal >= threshold;
}

function checkAllMembersPositiveToday(franchise, players) {
  const today = new Date().toISOString().split('T')[0];
  const franchisePlayers = players.filter(p => p.franchise === franchise);
  
  for (const player of franchisePlayers) {
    const history = BADGE_STORAGE.actionHistory[player.name];
    if (!history) return false;
    
    const todayActions = history.filter(action => action.dateKey === today);
    const hasPositiveToday = todayActions.some(action => action.isPositive);
    
    if (!hasPositiveToday) return false;
  }
  
  return franchisePlayers.length > 0;
}

// ===============================================
// 6. FONCTIONS D'ATTRIBUTION DES BADGES
// ===============================================

/**
 * Attribuer un badge individuel
 */
function awardBadge(playerName, badgeId, badge, type) {
  if (!BADGE_STORAGE.individual[playerName]) {
    BADGE_STORAGE.individual[playerName] = [];
  }
  
  const badgeEntry = {
    badgeId,
    name: badge.name,
    emoji: badge.emoji,
    description: badge.description,
    rarity: badge.rarity,
    pointsBonus: badge.points_bonus || 0,
    dateEarned: new Date(),
    type
  };
  
  BADGE_STORAGE.individual[playerName].push(badgeEntry);
  
  console.log(`üéâ Badge attribu√© √† ${playerName}: ${badge.emoji} ${badge.name}`);
  
  // Retourner les infos pour les notifications
  return badgeEntry;
}

/**
 * Attribuer un badge collectif
 */
function awardFranchiseBadge(franchise, badgeId, badge) {
  if (!BADGE_STORAGE.collective[franchise]) {
    BADGE_STORAGE.collective[franchise] = [];
  }
  
  const badgeEntry = {
    badgeId,
    name: badge.name,
    emoji: badge.emoji,
    description: badge.description,
    rarity: badge.rarity,
    franchisePoints: badge.franchise_points || 0,
    dateEarned: new Date(),
    type: 'collective'
  };
  
  BADGE_STORAGE.collective[franchise].push(badgeEntry);
  
  console.log(`üè† Badge collectif attribu√© √† ${franchise}: ${badge.emoji} ${badge.name}`);
  
  return badgeEntry;
}

// ===============================================
// 7. FONCTIONS UTILITAIRES
// ===============================================

/**
 * V√©rifier si un joueur poss√®de d√©j√† un badge
 */
function hasPlayerBadge(playerName, badgeId) {
  const playerBadges = BADGE_STORAGE.individual[playerName] || [];
  return playerBadges.some(badge => badge.badgeId === badgeId);
}

/**
 * V√©rifier si une franchise poss√®de d√©j√† un badge
 */
function hasFranchiseBadge(franchise, badgeId) {
  const franchiseBadges = BADGE_STORAGE.collective[franchise] || [];
  return franchiseBadges.some(badge => badge.badgeId === badgeId);
}

/**
 * Obtenir tous les badges d'un joueur
 */
function getPlayerBadges(playerName) {
  return BADGE_STORAGE.individual[playerName] || [];
}

/**
 * Obtenir tous les badges d'une franchise
 */
function getFranchiseBadges(franchise) {
  return BADGE_STORAGE.collective[franchise] || [];
}

/**
 * Obtenir les statistiques de progression d'un joueur
 */
function getPlayerProgress(playerName) {
  const streak = BADGE_STORAGE.streaks[playerName] || {
    currentPositiveStreak: 0,
    consecutiveDaysPositive: 0
  };
  
  return {
    currentStreak: streak.currentPositiveStreak,
    consecutiveDays: streak.consecutiveDaysPositive,
    totalActions: (BADGE_STORAGE.actionHistory[playerName] || []).length,
    badges: getPlayerBadges(playerName).length
  };
}

// ===============================================
// 8. FONCTION PRINCIPALE D'INT√âGRATION
// ===============================================

/**
 * Fonction principale √† appeler lors de l'ajout de points
 * Remplace ou compl√®te votre fonction addPoints existante
 */
function processActionWithBadges(playerName, points, action, currentScore, franchise, allPlayers) {
  console.log(`üéØ Traitement action avec badges: ${playerName} - ${action} (${points} pts)`);
  
  // 1. Tracker l'action
  trackAction(playerName, points, action);
  
  // 2. V√©rifier les badges individuels
  const newIndividualBadges = checkAllBadgesForPlayer(playerName, currentScore, franchise);
  
  // 3. V√©rifier les badges collectifs pour la franchise
  const franchisePlayers = allPlayers.filter(p => p.franchise === franchise);
  const newCollectiveBadges = checkAllBadgesForFranchise(franchise, franchisePlayers);
  
  // 4. Retourner les notifications de badges
  return {
    individualBadges: newIndividualBadges,
    collectiveBadges: newCollectiveBadges,
    playerProgress: getPlayerProgress(playerName)
  };
}
// TEST TEMPORAIRE - √Ä SUPPRIMER APR√àS
console.log("‚úÖ Syst√®me badges charg√© !");
document.title = "GPBM avec Badges ‚úÖ";
        const App = () => {
          const [currentView, setCurrentView] = useState('home');
          const [userType, setUserType] = useState(null);
          const [players, setPlayers] = useState([]);
          const [expandedDropdown, setExpandedDropdown] = useState(null);
          const [selectedPlayerHistory, setSelectedPlayerHistory] = useState(null);
          const [playerHistory, setPlayerHistory] = useState([]);
          const [loading, setLoading] = useState(false);
          const [password, setPassword] = useState('');
          const [loginError, setLoginError] = useState('');
          const [teacherName, setTeacherName] = useState('');
          const [selectedStudent, setSelectedStudent] = useState('');
          const [newStudentName, setNewStudentName] = useState('');
          const [newStudentFranchise, setNewStudentFranchise] = useState('Minotaurs');
          const [searchName, setSearchName] = useState('');
          const [foundPlayer, setFoundPlayer] = useState(null);
          const [searchHistory, setSearchHistory] = useState([]);
          const [showEvolutionChart, setShowEvolutionChart] = useState(false);
          const [chartData, setChartData] = useState(null);
          const [chartType, setChartType] = useState('player');
          
          // Fonction pour obtenir le grade basketball selon le score
const getBadge = (score) => {
  // Grade Ultime
  if (score >= 250) return { 
    emoji: 'üêê', 
    name: 'GOAT', 
    fullName: 'Greatest Of All Time',
    color: 'text-purple-300',
    bgColor: 'from-purple-600 to-purple-800',
    description: 'Le plus grand de tous les temps'
  };
  
  // Grades Elite
  if (score >= 200) return { 
    emoji: 'üèõÔ∏è', 
    name: 'Hall of Fame', 
    fullName: 'Hall of Fame',
    color: 'text-yellow-300',
    bgColor: 'from-yellow-500 to-yellow-700',
    description: 'L√©gende du sport'
  };
  if (score >= 150) return { 
    emoji: 'üî•', 
    name: 'Superstar', 
    fullName: 'Superstar',
    color: 'text-orange-300',
    bgColor: 'from-orange-500 to-red-600',
    description: 'Ph√©nom√®ne basketball'
  };
  
  // Grades Confirm√©s
  if (score >= 100) return { 
    emoji: 'üåü', 
    name: 'All-Star', 
    fullName: 'All-Star',
    color: 'text-blue-300',
    bgColor: 'from-blue-500 to-blue-700',
    description: 'S√©lectionn√© parmi l\'√©lite'
  };
  if (score >= 75) return { 
    emoji: 'üíé', 
    name: 'Franchise Player', 
    fullName: 'Franchise Player',
    color: 'text-cyan-300',
    bgColor: 'from-cyan-500 to-blue-600',
    description: 'Pilier de l\'√©quipe'
  };
  
  // Grades D√©veloppement
  if (score >= 50) return { 
    emoji: '‚≠ê', 
    name: 'Starting Five', 
    fullName: 'Starting Five',
    color: 'text-green-300',
    bgColor: 'from-green-500 to-green-700',
    description: 'Titulaire indiscutable'
  };
  if (score >= 25) return { 
    emoji: 'üèÉ', 
    name: 'Sixth Man', 
    fullName: 'Sixth Man',
    color: 'text-emerald-300',
    bgColor: 'from-emerald-500 to-green-600',
    description: 'Premier rempla√ßant de qualit√©'
  };
  
  // Grades D√©butants
  if (score >= 10) return { 
    emoji: 'üèÄ', 
    name: 'Rookie', 
    fullName: 'Rookie',
    color: 'text-amber-300',
    bgColor: 'from-amber-500 to-orange-500',
    description: 'D√©butant prometteur'
  };
  if (score >= 0) return { 
    emoji: 'üë∂', 
    name: 'Freshman', 
    fullName: 'Freshman',
    color: 'text-yellow-300',
    bgColor: 'from-yellow-400 to-amber-500',
    description: 'Premi√®re ann√©e, apprend les bases'
  };
  
  // Grades N√©gatifs
  if (score >= -25) return { 
    emoji: 'üìâ', 
    name: 'Plot', 
    fullName: 'Plot',
    color: 'text-gray-400',
    bgColor: 'from-gray-500 to-gray-700',
    description: 'Personnage sans importance'
  };
  if (score >= -50) return { 
    emoji: 'ü™ë', 
    name: 'Benchwarmer', 
    fullName: 'Benchwarmer',
    color: 'text-red-400',
    bgColor: 'from-red-500 to-red-700',
    description: 'Clou√© sur le banc'
  };
  
  // Pire niveau
  return { 
    emoji: 'üóëÔ∏è', 
    name: 'Scrub', 
    fullName: 'Scrub',
    color: 'text-red-600',
    bgColor: 'from-red-700 to-red-900',
    description: 'Le pire niveau possible'
  };
};

          // Fonction pour obtenir l'avatar anim√© de la franchise
          const getFranchiseAvatar = (franchise) => {
            const avatars = {
              Minotaurs: { emoji: 'üêÇ', class: 'minotaur-avatar', name: 'Taureau Enrag√©' },
              Krakens: { emoji: 'üêô', class: 'kraken-avatar', name: 'Kraken des Profondeurs' },
              Phoenix: { emoji: 'üî•', class: 'phoenix-avatar', name: 'Phoenix √âternel' },
              Werewolves: { emoji: 'üê∫', class: 'werewolf-avatar', name: 'Loup-Garou' }
            };
            return avatars[franchise] || { emoji: '‚ö°', class: 'franchise-avatar', name: 'Guerrier' };
          };

          // Actions positives et n√©gatives
          const positiveActions = [
            { label: 'Hardworker', points: 6 },
            { label: 'Victoire le weekend', points: 4 },
            { label: 'Participation le weekend', points: 2 },
            { label: 'Entrainement/atelier facultatif', points: 4 },
            { label: 'Observation positive', points: 5 },
            { label: 'Bonus', points: 2 },
            { label: 'Bonus', points: 3 },
            { label: 'Bonus', points: 5 },
            { label: 'Bonus', points: 10 },
            { label: 'F√©licitations', points: 25 },
            { label: 'Compliments', points: 15 },
            { label: 'Encouragements', points: 10 }
          ];

          const negativeActions = [
            { label: 'Observation n√©gative', points: -5 },
            { label: 'Exclusion de cours', points: -8 },
            { label: 'Exclusion temporaire de l\'√©tablissement', points: -15 },
            { label: 'Travail non fait', points: -3 },
            { label: 'Retard/absence non justifi√©e', points: -3 },
            { label: 'Absence non justifi√©e au club', points: -3 },
            { label: 'P√©nalit√©', points: -2 },
            { label: 'P√©nalit√©', points: -3 },
            { label: 'P√©nalit√©', points: -5 }
          ];

          // Couleurs des franchises
          const franchiseColors = {
            Minotaurs: 'from-red-600 to-red-800',
            Krakens: 'from-blue-600 to-blue-800',
            Phoenix: 'from-orange-600 to-orange-800',
            Werewolves: 'from-green-600 to-green-800'
          };

          // V√©rifier le mot de passe professeur
          const verifyTeacher = async () => {
            if (!password.trim()) {
              setLoginError('Veuillez entrer un mot de passe');
              return;
            }
            
            try {
              const response = await fetch('/api/verify-teacher', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
              });
              
              const data = await response.json();
              if (data.success) {
                setUserType('teacher');
                setCurrentView('teacher-dashboard');
                setLoginError('');
              } else {
                setLoginError('Mot de passe incorrect');
              }
            } catch (error) {
              setLoginError('Erreur de connexion');
            }
          };

          // Charger les joueurs
          const loadPlayers = async () => {
            try {
              const response = await fetch('/api/players');
              const data = await response.json();
              setPlayers(data);
            } catch (error) {
              console.error('Erreur lors du chargement des joueurs:', error);
            }
          };

          // Ajouter des points (professeurs uniquement)
const addPoints = async (playerName, points, action) => {
  setLoading(true);
  try {
    const response = await fetch('/api/add-points', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ playerName, points, action, teacherName })
    });
    
    if (response.ok) {
      // D'abord recharger les donn√©es
      await loadPlayers();
      
      // Ensuite v√©rifier les badges avec les nouvelles donn√©es
      setTimeout(() => {
        const player = players.find(p => p.name === playerName);
        if (player) {
          const badgeResult = processActionWithBadges(
            playerName, 
            points, 
            action, 
            player.score, // Score actuel (d√©j√† mis √† jour)
            player.franchise, 
            players
          );
          
          // Afficher les notifications de nouveaux badges
          if (badgeResult.individualBadges.length > 0) {
            badgeResult.individualBadges.forEach(({ badge }) => {
              alert(`üéâ ${playerName} a d√©bloqu√© le badge : ${badge.emoji} ${badge.name}!\n${badge.description}\n+${badge.points_bonus} points bonus`);
            });
          }
          
          if (badgeResult.collectiveBadges.length > 0) {
            badgeResult.collectiveBadges.forEach(({ badge }) => {
              alert(`üè† La franchise ${player.franchise} a d√©bloqu√© : ${badge.emoji} ${badge.name}!\n${badge.description}\n+${badge.franchise_points} points franchise`);
            });
          }
        }
      }, 100); // Petit d√©lai pour s'assurer que les donn√©es sont bien mises √† jour
      
      setExpandedDropdown(null);
    }
  } catch (error) {
    console.error('Erreur lors de l\'ajout de points:', error);
  }
  setLoading(false);
};

          // Charger l'historique d'un joueur
          const loadPlayerHistory = async (playerName) => {
            try {
              const response = await fetch(`/api/history/${encodeURIComponent(playerName)}`);
              const data = await response.json();
              setPlayerHistory(data);
              setSelectedPlayerHistory(playerName);
            } catch (error) {
              console.error('Erreur lors du chargement de l\'historique:', error);
            }
          };

          // Annuler la derni√®re action (professeurs uniquement)
          const undoLastAction = async (playerName) => {
            setLoading(true);
            try {
              const response = await fetch(`/api/undo-last/${encodeURIComponent(playerName)}`, {
                method: 'DELETE',
              });
              
              if (response.ok) {
                await loadPlayers();
              }
            } catch (error) {
              console.error('Erreur lors de l\'annulation:', error);
            }
            setLoading(false);
          };

          // Ajouter un √©l√®ve (professeurs uniquement)
          const addStudent = async () => {
            if (!newStudentName.trim()) {
              alert('Veuillez entrer un nom');
              return;
            }
            
            try {
              const response = await fetch('/api/add-student', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                  name: newStudentName.trim(), 
                  franchise: newStudentFranchise 
                })
              });
              
              if (response.ok) {
                setNewStudentName('');
                await loadPlayers();
                alert('√âl√®ve ajout√© avec succ√®s !');
              } else {
                const error = await response.json();
                alert(error.error || 'Erreur lors de l\'ajout');
              }
            } catch (error) {
              alert('Erreur lors de l\'ajout de l\'√©l√®ve');
            }
          };

          // Supprimer un √©l√®ve (professeurs uniquement)
          const removeStudent = async (playerName) => {
            if (!confirm(`√ätes-vous s√ªr de vouloir supprimer ${playerName} ? Cette action est irr√©versible.`)) {
              return;
            }
            
            try {
              const response = await fetch(`/api/remove-student/${encodeURIComponent(playerName)}`, {
                method: 'DELETE'
              });
              
              if (response.ok) {
                await loadPlayers();
                alert('√âl√®ve supprim√© avec succ√®s');
              }
            } catch (error) {
              alert('Erreur lors de la suppression');
            }
          };

          useEffect(() => {
            if (userType) {
              loadPlayers();
              const interval = setInterval(loadPlayers, 10000);
              return () => clearInterval(interval);
            }
          }, [userType]);

          // Obtenir les joueurs tri√©s par score pour une franchise
          const getSortedPlayers = (franchise) => {
            return players
              .filter(player => player.franchise === franchise)
              .sort((a, b) => b.score - a.score);
          };

          // Obtenir le classement des franchises
          const getFranchiseRankings = () => {
            const franchiseScores = {};
            ['Minotaurs', 'Krakens', 'Phoenix', 'Werewolves'].forEach(franchise => {
              franchiseScores[franchise] = players
                .filter(player => player.franchise === franchise)
                .reduce((total, player) => total + player.score, 0);
            });
            
            return Object.entries(franchiseScores)
              .sort(([,a], [,b]) => b - a)
              .map(([franchise, score], index) => ({ franchise, score, rank: index + 1 }));
          };

          // Obtenir le classement g√©n√©ral des joueurs
          const getGeneralPlayerRankings = () => {
            return [...players].sort((a, b) => b.score - a.score);
          };

          // PAGE D'ACCUEIL - CHOIX DU TYPE D'UTILISATEUR
          if (currentView === 'home') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 p-8">
                <div className="max-w-4xl mx-auto">
                  <h1 className="text-6xl font-bold text-center text-white mb-4">
                    üèÜ Syst√®me de Gestion Scolaire üèÜ
                  </h1>
                  <p className="text-xl text-center text-purple-200 mb-12">
                    Choisissez votre type d'acc√®s
                  </p>
                  
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <button
                      onClick={() => setCurrentView('teacher-login')}
                      className="group relative overflow-hidden bg-gradient-to-r from-emerald-600 to-emerald-800 hover:from-emerald-500 hover:to-emerald-700 text-white p-8 rounded-xl shadow-2xl transform hover:scale-105 transition-all duration-300"
                    >
                      <div className="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition-opacity duration-300"></div>
                      <div className="relative z-10 flex flex-col items-center">
                        <div className="text-6xl mb-4">üë®‚Äçüè´</div>
                        <h2 className="text-3xl font-bold mb-2">PROFESSEUR</h2>
                        <p className="text-emerald-100">Gestion compl√®te</p>
                        <p className="text-sm text-emerald-200 mt-2">üîê Mot de passe requis</p>
                      </div>
                    </button>
                    
                    <button
                      onClick={() => {
                        setUserType('student');
                        setCurrentView('student-dashboard');
                      }}
                      className="group relative overflow-hidden bg-gradient-to-r from-amber-600 to-amber-800 hover:from-amber-500 hover:to-amber-700 text-white p-8 rounded-xl shadow-2xl transform hover:scale-105 transition-all duration-300"
                    >
                      <div className="absolute inset-0 bg-white opacity-0 group-hover:opacity-10 transition-opacity duration-300"></div>
                      <div className="relative z-10 flex flex-col items-center">
                        <div className="text-6xl mb-4">üë®‚Äçüéì</div>
                        <h2 className="text-3xl font-bold mb-2">√âL√àVE</h2>
                        <p className="text-amber-100">Consultation des scores</p>
                        <p className="text-sm text-amber-200 mt-2">üëÅÔ∏è Lecture seule</p>
                      </div>
                    </button>
                  </div>
                </div>
              </div>
            );
          }

          // PAGE DE CONNEXION PROFESSEUR
          if (currentView === 'teacher-login') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 p-8 flex items-center justify-center">
                <div className="bg-white/10 backdrop-blur-sm rounded-xl p-8 max-w-md w-full">
                  <h2 className="text-3xl font-bold text-white text-center mb-8">
                    üîê Connexion Professeur
                  </h2>
                  
                  <div className="space-y-6">
                    <div>
                      <label className="block text-white text-sm font-bold mb-2">
                        Nom (optionnel)
                      </label>
                      <input
                        type="text"
                        value={teacherName}
                        onChange={(e) => setTeacherName(e.target.value)}
                        className="w-full px-3 py-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30 focus:border-white/70 focus:outline-none"
                        placeholder="Votre nom..."
                      />
                    </div>
                    
                    <div>
                      <label className="block text-white text-sm font-bold mb-2">
                        Mot de passe *
                      </label>
                      <input
                        type="password"
                        value={password}
                        onChange={(e) => setPassword(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && verifyTeacher()}
                        className="w-full px-3 py-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30 focus:border-white/70 focus:outline-none"
                        placeholder="Mot de passe..."
                      />
                    </div>
                    
                    {loginError && (
                      <div className="text-red-300 text-sm text-center">
                        {loginError}
                      </div>
                    )}
                    
                    <div className="flex space-x-4">
                      <button
                        onClick={() => setCurrentView('home')}
                        className="flex-1 bg-gray-600 hover:bg-gray-500 text-white py-3 rounded-lg transition-colors"
                      >
                        ‚Üê Retour
                      </button>
                      <button
                        onClick={verifyTeacher}
                        className="flex-1 bg-emerald-600 hover:bg-emerald-500 text-white py-3 rounded-lg transition-colors"
                      >
                        Se connecter
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          // TABLEAU DE BORD PROFESSEUR
          if (currentView === 'teacher-dashboard') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 p-8">
                <div className="max-w-6xl mx-auto">
                  <div className="flex justify-between items-center mb-8">
                    <h1 className="text-4xl font-bold text-white">
                      üë®‚Äçüè´ Tableau de Bord Professeur
                      {teacherName && <span className="text-2xl text-purple-200"> - {teacherName}</span>}
                    </h1>
                    <button
                      onClick={() => {
                        setCurrentView('home');
                        setUserType(null);
                        setPassword('');
                        setTeacherName('');
                      }}
                      className="bg-red-600 hover:bg-red-500 text-white px-6 py-3 rounded-lg transition-colors"
                    >
                      üö™ D√©connexion
                    </button>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <button
                      onClick={() => setCurrentView('teacher-players')}
                      className="bg-gradient-to-r from-emerald-600 to-emerald-800 hover:from-emerald-500 hover:to-emerald-700 text-white p-6 rounded-xl shadow-2xl transform hover:scale-105 transition-all duration-300"
                    >
                      <div className="text-4xl mb-2">üë•</div>
                      <h3 className="text-xl font-bold">Gestion des Points</h3>
                      <p className="text-emerald-100 text-sm">Ajouter/retirer des points</p>
                    </button>
                    
                    <button
                      onClick={() => setCurrentView('teacher-admin')}
                      className="bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-500 hover:to-blue-700 text-white p-6 rounded-xl shadow-2xl transform hover:scale-105 transition-all duration-300"
                    >
                      <div className="text-4xl mb-2">‚öôÔ∏è</div>
                      <h3 className="text-xl font-bold">Administration</h3>
                      <p className="text-blue-100 text-sm">G√©rer les √©l√®ves</p>
                    </button>
                    
                    <button
                      onClick={() => setCurrentView('rankings')}
                      className="bg-gradient-to-r from-amber-600 to-amber-800 hover:from-amber-500 hover:to-amber-700 text-white p-6 rounded-xl shadow-2xl transform hover:scale-105 transition-all duration-300"
                    >
                      <div className="text-4xl mb-2">üèÜ</div>
                      <h3 className="text-xl font-bold">Classements</h3>
                      <p className="text-amber-100 text-sm">Voir les r√©sultats</p>
                    </button>
                  </div>

                  <div className="bg-white/10 backdrop-blur-sm rounded-xl p-6">
                    <h3 className="text-2xl font-bold text-white mb-4">üìä Statistiques Rapides</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      {['Minotaurs', 'Krakens', 'Phoenix', 'Werewolves'].map(franchise => {
                        const franchisePlayers = getSortedPlayers(franchise);
                        const totalPoints = franchisePlayers.reduce((sum, player) => sum + player.score, 0);
                        const avatar = getFranchiseAvatar(franchise);
                        return (
                          <div key={franchise} className={`bg-gradient-to-r ${franchiseColors[franchise]} p-4 rounded-lg text-center franchise-card`}>
                            <div className="flex items-center justify-center mb-2">
                              <span className={`franchise-avatar ${avatar.class}`}>
                                {avatar.emoji}
                              </span>
                            </div>
                            <h4 className="font-bold text-white">{franchise}</h4>
                            <div className="text-2xl font-bold text-white">{totalPoints}</div>
                            <div className="text-sm text-white/80">{franchisePlayers.length} √©l√®ves</div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          // GESTION DES POINTS PROFESSEUR
          if (currentView === 'teacher-players') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 p-8">
                <div className="max-w-7xl mx-auto">
                  <div className="flex justify-between items-center mb-8">
                    <h1 className="text-4xl font-bold text-white">üë• Gestion des Points</h1>
                    <div className="flex space-x-4">
                      {loading && <div className="text-white">‚è≥ Chargement...</div>}
                      <button
                        onClick={() => setCurrentView('teacher-dashboard')}
                        className="bg-gray-600 hover:bg-gray-500 text-white px-6 py-3 rounded-lg transition-colors"
                      >
                        ‚Üê Retour Tableau de Bord
                      </button>
                    </div>
                  </div>

                  <div className="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-4 gap-6">
                    {['Minotaurs', 'Krakens', 'Phoenix', 'Werewolves'].map(franchise => {
                      const avatar = getFranchiseAvatar(franchise);
                      return (
                        <div key={franchise} className="bg-white/10 backdrop-blur-sm rounded-xl p-6 franchise-card">
                          <h2 className={`text-2xl font-bold text-white mb-4 text-center bg-gradient-to-r ${franchiseColors[franchise]} p-3 rounded-lg flex items-center justify-center space-x-2`}>
                            <span className={`franchise-avatar ${avatar.class}`}>
                              {avatar.emoji}
                            </span>
                            <span>{franchise}</span>
                          </h2>
                          <div className="space-y-3">
                            {getSortedPlayers(franchise).map(player => (
                              <div key={player.name} className="bg-white/20 rounded-lg p-3">
                                <div className="flex justify-between items-center mb-2">
                                  <button
                                    onClick={() => loadPlayerHistory(player.name)}
                                    className="text-white font-semibold hover:text-yellow-300 transition-colors flex items-center space-x-1"
                                  >
                                    <span>{player.name}</span>
                                    <span>üìã</span>
                                  </button>
                                  <div className="flex items-center space-x-2">
                                    <div className="flex items-center space-x-1">
                                      <span className={`text-2xl ${getBadge(player.score).emoji}`}>
                                        {getBadge(player.score).emoji}
                                      </span>
                                      <span className="text-white font-bold">
                                        {player.score} pts
                                      </span>
                                    </div>
                                    <button
                                      onClick={() => undoLastAction(player.name)}
                                      className="bg-red-500 hover:bg-red-400 text-white px-2 py-1 rounded text-xs"
                                      title="Annuler derni√®re action"
                                    >
                                      ‚Ü∫
                                    </button>
                                  </div>
                                </div>
                                
                                <div className="relative">
                                  <button
                                    onClick={() => setExpandedDropdown(expandedDropdown === player.name ? null : player.name)}
                                    className="w-full bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded flex justify-between items-center transition-colors"
                                    disabled={loading}
                                  >
                                    <span>Actions</span>
                                    <span>{expandedDropdown === player.name ? '‚åÉ' : '‚åÑ'}</span>
                                  </button>
                                  
                                  {expandedDropdown === player.name && (
                                    <div className="absolute top-full left-0 right-0 bg-white rounded-lg shadow-xl z-10 mt-1 max-h-64 overflow-y-auto">
                                      <div className="p-2">
                                        <div className="text-green-700 font-semibold mb-2">Points positifs:</div>
                                        {positiveActions.map((action, index) => (
                                          <button
                                            key={`pos-${index}`}
                                            onClick={() => addPoints(player.name, action.points, action.label)}
                                            className="w-full text-left px-3 py-2 hover:bg-green-100 rounded text-sm flex justify-between"
                                            disabled={loading}
                                          >
                                            <span>{action.label}</span>
                                            <span className="text-green-600 font-bold">+{action.points}</span>
                                          </button>
                                        ))}
                                        
                                        <div className="text-red-700 font-semibold mb-2 mt-3">Points n√©gatifs:</div>
                                        {negativeActions.map((action, index) => (
                                          <button
                                            key={`neg-${index}`}
                                            onClick={() => addPoints(player.name, action.points, action.label)}
                                            className="w-full text-left px-3 py-2 hover:bg-red-100 rounded text-sm flex justify-between"
                                            disabled={loading}
                                          >
                                            <span>{action.label}</span>
                                            <span className="text-red-600 font-bold">{action.points}</span>
                                          </button>
                                        ))}
                                      </div>
                                    </div>
                                  )}
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              </div>
            );
          }

          // ADMINISTRATION PROFESSEUR
          if (currentView === 'teacher-admin') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 p-8">
                <div className="max-w-6xl mx-auto">
                  <div className="flex justify-between items-center mb-8">
                    <h1 className="text-4xl font-bold text-white">‚öôÔ∏è Administration des √âl√®ves</h1>
                    <button
                      onClick={() => setCurrentView('teacher-dashboard')}
                      className="bg-gray-600 hover:bg-gray-500 text-white px-6 py-3 rounded-lg transition-colors"
                    >
                      ‚Üê Retour Tableau de Bord
                    </button>
                  </div>

                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div className="bg-white/10 backdrop-blur-sm rounded-xl p-6">
                      <h2 className="text-2xl font-bold text-white mb-6 text-center">
                        ‚ûï Ajouter un √âl√®ve
                      </h2>
                      <div className="space-y-4">
                        <div>
                          <label className="block text-white text-sm font-bold mb-2">
                            Nom de l'√©l√®ve
                          </label>
                          <input
                            type="text"
                            value={newStudentName}
                            onChange={(e) => setNewStudentName(e.target.value)}
                            className="w-full px-3 py-2 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30 focus:border-white/70 focus:outline-none"
                            placeholder="Pr√©nom Nom..."
                          />
                        </div>
                        
                        <div>
                          <label className="block text-white text-sm font-bold mb-2">
                            Franchise
                          </label>
                          <select
                            value={newStudentFranchise}
                            onChange={(e) => setNewStudentFranchise(e.target.value)}
                            className="w-full px-3 py-2 rounded-lg bg-white/20 text-white border border-white/30 focus:border-white/70 focus:outline-none"
                          >
                            <option value="Minotaurs" className="text-black">Minotaurs</option>
                            <option value="Krakens" className="text-black">Krakens</option>
                            <option value="Phoenix" className="text-black">Phoenix</option>
                            <option value="Werewolves" className="text-black">Werewolves</option>
                          </select>
                        </div>
                        
                        <button
                          onClick={addStudent}
                          className="w-full bg-green-600 hover:bg-green-500 text-white py-3 rounded-lg transition-colors font-bold"
                        >
                          ‚ûï Ajouter l'√âl√®ve
                        </button>
                      </div>
                    </div>

                    <div className="bg-white/10 backdrop-blur-sm rounded-xl p-6">
                      <h2 className="text-2xl font-bold text-white mb-6 text-center">
                        üóëÔ∏è Supprimer un √âl√®ve
                      </h2>
                      <div className="space-y-4">
                        <div>
                          <label className="block text-white text-sm font-bold mb-2">
                            S√©lectionner un √©l√®ve
                          </label>
                          <select
                            value={selectedStudent}
                            onChange={(e) => setSelectedStudent(e.target.value)}
                            className="w-full px-3 py-2 rounded-lg bg-white/20 text-white border border-white/30 focus:border-white/70 focus:outline-none"
                          >
                            <option value="" className="text-black">-- Choisir un √©l√®ve --</option>
                            {players
                              .sort((a, b) => a.name.localeCompare(b.name))
                              .map(player => (
                                <option key={player.name} value={player.name} className="text-black">
                                  {player.name} ({player.franchise})
                                </option>
                              ))}
                          </select>
                        </div>
                        
                        <button
                          onClick={() => selectedStudent && removeStudent(selectedStudent)}
                          disabled={!selectedStudent}
                          className="w-full bg-red-600 hover:bg-red-500 disabled:bg-gray-500 disabled:cursor-not-allowed text-white py-3 rounded-lg transition-colors font-bold"
                        >
                          üóëÔ∏è Supprimer l'√âl√®ve
                        </button>
                        
                        <p className="text-red-300 text-sm text-center">
                          ‚ö†Ô∏è Cette action est irr√©versible !
                        </p>
                      </div>
                    </div>
                  </div>

                  <div className="mt-8 bg-white/10 backdrop-blur-sm rounded-xl p-6">
                    <h2 className="text-2xl font-bold text-white mb-6 text-center">
                      üìã Liste Actuelle des √âl√®ves
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                      {['Minotaurs', 'Krakens', 'Phoenix', 'Werewolves'].map(franchise => {
                        const avatar = getFranchiseAvatar(franchise);
                        return (
                          <div key={franchise} className={`bg-gradient-to-r ${franchiseColors[franchise]} p-4 rounded-lg franchise-card`}>
                            <div className="flex items-center justify-center mb-3">
                              <span className={`franchise-avatar ${avatar.class}`}>
                                {avatar.emoji}
                              </span>
                              <h3 className="text-xl font-bold text-white ml-2">{franchise}</h3>
                            </div>
                            <div className="space-y-2">
                              {getSortedPlayers(franchise).map(player => (
                                <div key={player.name} className="bg-white/20 p-2 rounded text-white text-sm">
                                  <div className="flex justify-between items-center">
                                    <span>{player.name}</span>
                                    <span className="font-bold">{player.score} pts</span>
                                  </div>
                                </div>
                              ))}
                            </div>
                            <div className="text-center mt-3 text-white/80 text-sm">
                              {getSortedPlayers(franchise).length} √©l√®ve(s)
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          // TABLEAU DE BORD √âL√àVE
          if (currentView === 'student-dashboard') {
            return (
              <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 p-8">
                <div className="max-w-4xl mx-auto">
                  <div className="flex justify-between items-center mb-8">
                    <h1 className="text-4xl font-bold text-white">üë®‚Äçüéì Espace √âl√®ve</h1>
                    <button
                      onClick={() => {
                        setCurrentView('home');
                        setUserType(null);
                      }}
                      className="bg-gray-600 hover:bg-gray-500 text-white px-6 py-3 rounded-lg transition-colors"
                    >
                      ‚Üê Retour Accueil
                    </button>
                  </div>

                  <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                    <button
                      onClick={() => setCurrentView('student-search')}
                      className="bg-gradient-to-r from-blue-600 to-blue-800 hover:from-blue-500 hover:to-blue-700 text-white p-6 rounded-xl shadow-2xl transform hover:scale-105 transition-all duration-300"
                    >
                      <div className="text-4xl mb-2">üîç</div>
                      <h3 className="text-xl font-bold">Mon Score</h3>
                      <p className="text-blue-100 text-sm">Voir mon historique personnel</p>
                    </button>
                    
                    <button
                      onClick={() => setCurrentView('rankings')}
                      className="bg-gradient-to-r from-amber-600 to-amber-800 hover:from-amber-500 hover:to-amber-700 text-white p-6 rounded-xl shadow-2xl transform hover:scale-105 transition-all duration-300"
                    >
                      <div className="text-4xl mb-2">üèÜ</div>
                      <h3 className="text-xl font-bold">Classements</h3>
                      <p className="text-amber-100 text-sm">Voir tous les classements</p>
                    </button>
                  </div>

                  <div className="bg-white/10 backdrop-blur-sm rounded-xl p-6">
                    <h3 className="text-2xl font-bold text-white mb-6 text-center">
                      üè† Les Quatre Franchises
                    </h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      {['Minotaurs', 'Krakens', 'Phoenix', 'Werewolves'].map(franchise => {
                        const franchisePlayers = getSortedPlayers(franchise);
                        const totalPoints = franchisePlayers.reduce((sum, player) => sum + player.score, 0);
                        const avatar = getFranchiseAvatar(franchise);
                        return (
                          <div key={franchise} className={`bg-gradient-to-r ${franchiseColors[franchise]} p-4 rounded-lg text-center franchise-card`}>
                            <div className="flex items-center justify-center mb-2">
                              <span className={`franchise-avatar ${avatar.class}`}>
                                {avatar.emoji}
                              </span>
                            </div>
                            <h4 className="font-bold text-white text-lg">{franchise}</h4>
                            <div className="text-2xl font-bold text-white">{totalPoints}</div>
                            <div className="text-sm text-white/80">{franchisePlayers.length} √©l√®ves</div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          // RECHERCHE √âL√àVE
          if (currentView === 'student-search') {
            
            const searchPlayer = async () => {
              if (!searchName.trim()) {
                alert('Veuillez entrer votre nom');
                return;
              }

              try {
                const response = await fetch(`/api/player/${encodeURIComponent(searchName.trim())}`);
                if (response.ok) {
                  const player = await response.json();
                  setFoundPlayer(player);
                  
                  const historyResponse = await fetch(`/api/history/${encodeURIComponent(searchName.trim())}`);
                  const history = await historyResponse.json();
                  setSearchHistory(history);
                } else {
                  setFoundPlayer(null);
                  setSearchHistory([]);
                  alert('√âl√®ve non trouv√©. V√©rifiez l\'orthographe de votre nom.');
                }
              } catch (error) {
                alert('Erreur lors de la recherche');
              }
            };

            return (
              <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 p-8">
                <div className="max-w-4xl mx-auto">
                  <div className="flex justify-between items-center mb-8">
                    <h1 className="text-4xl font-bold text-white">üîç Rechercher Mon Score</h1>
                    <button
                      onClick={() => setCurrentView('student-dashboard')}
                      className="bg-gray-600 hover:bg-gray-500 text-white px-6 py-3 rounded-lg transition-colors"
                    >
                      ‚Üê Retour
                    </button>
                  </div>

                  <div className="bg-white/10 backdrop-blur-sm rounded-xl p-6 mb-8">
                    <h2 className="text-2xl font-bold text-white mb-6 text-center">
                      Entrez votre nom complet
                    </h2>
                    <div className="flex space-x-4">
                      <input
                        type="text"
                        value={searchName}
                        onChange={(e) => setSearchName(e.target.value)}
                        onKeyPress={(e) => e.key === 'Enter' && searchPlayer()}
                        className="flex-1 px-4 py-3 rounded-lg bg-white/20 text-white placeholder-white/70 border border-white/30 focus:border-white/70 focus:outline-none text-lg"
                        placeholder="Votre pr√©nom et nom..."
                      />
                      <button
                        onClick={searchPlayer}
                        className="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-lg transition-colors font-bold"
                      >
                        üîç Rechercher
                      </button>
                    </div>
                  </div>

                  {foundPlayer && (
                    <div className="space-y-6">
                      <div className={`bg-gradient-to-r ${franchiseColors[foundPlayer.franchise]} p-6 rounded-xl franchise-card`}>
                        <div className="text-center">
                          <h2 className="text-3xl font-bold text-white mb-2">{foundPlayer.name}</h2>
                          <div className="text-xl text-white/90 mb-4 flex items-center justify-center space-x-3">
                            <span>Franchise:</span>
                            <div className="flex items-center space-x-2">
                              <span className={`franchise-avatar ${getFranchiseAvatar(foundPlayer.franchise).class}`}>
                                {getFranchiseAvatar(foundPlayer.franchise).emoji}
                              </span>
                              <span className="font-bold">{foundPlayer.franchise}</span>
                            </div>
                          </div>
                          <div className="mb-4">
                            <div className="inline-flex items-center space-x-2 bg-black/30 px-4 py-2 rounded-full">
                              <span className="text-3xl">{getBadge(foundPlayer.score).emoji}</span>
                              <span className={`text-xl font-bold ${getBadge(foundPlayer.score).color}`}>
                                {getBadge(foundPlayer.score).name}
                              </span>
                            </div>
                          </div>
                          <div className="text-5xl font-bold text-white">{foundPlayer.score} points</div>
                        </div>
                      </div>

                      <div className="bg-white/10 backdrop-blur-sm rounded-xl p-6">
                        <h3 className="text-2xl font-bold text-white mb-6 text-center">
                          üìã Mon Historique
                        </h3>
                        <div className="space-y-3 max-h-96 overflow-y-auto">
                          {searchHistory.length > 0 ? (
                            searchHistory.map((entry, index) => (
                              <div key={index} className="bg-white/20 p-4 rounded-lg">
                                <div className="flex justify-between items-start">
                                  <div>
                                    <div className="font-semibold text-white">{entry.action}</div>
                                    <div className="text-sm text-white/80">{entry.timestamp}</div>
                                    {entry.teacher_name && entry.teacher_name !== 'Anonyme' && (
                                      <div className="text-xs text-white/60">Par: {entry.teacher_name}</div>
                                    )}
                                  </div>
                                  <div className="text-right">
                                    <div className={`text-lg font-bold ${entry.points > 0 ? 'text-green-300' : 'text-red-300'}`}>
                                      {entry.points > 0 ? '+' : ''}{entry.points}
                                    </div>
                                    <div className="text-sm text-white/70">Total: {entry.new_total}</div>
                                  </div>
                                </div>
                              </div>
                            ))
                          ) : (
                            <p className="text-white/70 text-center">Aucun historique disponible</p>
                          )}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            );
          }

          // PAGE CLASSEMENTS
          if (currentView === 'rankings') {
            const franchiseRankings = getFranchiseRankings();
            const playerRankings = getGeneralPlayerRankings();

            return (
              <div className="min-h-screen bg-gradient-to-br from-purple-900 via-blue-900 to-indigo-900 p-8">
                <div className="max-w-6xl mx-auto">
                  <div className="flex justify-between items-center mb-8">
                    <h1 className="text-4xl font-bold text-white">üèÜ Classements</h1>
                    <button
                      onClick={() => setCurrentView(userType === 'teacher' ? 'teacher-dashboard' : 'student-dashboard')}
                      className="bg-gray-600 hover:bg-gray-500 text-white px-6 py-3 rounded-lg transition-colors"
                    >
                      ‚Üê Retour
                    </button>
                  </div>

                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div className="bg-white/10 backdrop-blur-sm rounded-xl p-6">
                      <h2 className="text-2xl font-bold text-white mb-6 text-center">
                        üèÜ Classement des Franchises
                      </h2>
                      <div className="space-y-4">
                        {franchiseRankings.map(({ franchise, score, rank }) => {
                          const avatar = getFranchiseAvatar(franchise);
                          return (
                            <div
                              key={franchise}
                              className={`bg-gradient-to-r ${franchiseColors[franchise]} p-4 rounded-lg flex justify-between items-center shadow-lg franchise-card`}
                            >
                              <div className="flex items-center space-x-3">
                                <span className="text-2xl font-bold text-white">#{rank}</span>
                                <span className={`franchise-avatar ${avatar.class}`}>
                                  {avatar.emoji}
                                </span>
                                <span className="text-xl font-semibold text-white">{franchise}</span>
                              </div>
                              <span className="text-2xl font-bold text-white">{score} pts</span>
                            </div>
                          );
                        })}
                      </div>
                    </div>

                    <div className="bg-white/10 backdrop-blur-sm rounded-xl p-6">
                      <h2 className="text-2xl font-bold text-white mb-6 text-center">
                        üëë Classement G√©n√©ral
                      </h2>
                      <div className="space-y-2 max-h-96 overflow-y-auto">
                        {playerRankings.map((player, index) => {
                          const badge = getBadge(player.score);
                          return (
                            <div
                              key={player.name}
                              className={`bg-gradient-to-r ${franchiseColors[player.franchise]} p-3 rounded-lg flex justify-between items-center shadow-md`}
                            >
                              <div className="flex items-center space-x-3">
                                <span className="text-lg font-bold text-white">#{index + 1}</span>
                                <span className="text-2xl">{badge.emoji}</span>
                                <div>
                                  <span className="text-lg font-semibold text-white">{player.name}</span>
                                  <div className="text-sm text-white/80">{player.franchise}</div>
                                </div>
                              </div>
                              <span className="text-lg font-bold text-white">{player.score} pts</span>
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            );
          }

          return (
            <>
              {selectedPlayerHistory && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-xl p-6 max-w-md w-full max-h-96 overflow-y-auto">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-xl font-bold">Historique de {selectedPlayerHistory}</h3>
                      <button
                        onClick={() => setSelectedPlayerHistory(null)}
                        className="text-gray-500 hover:text-gray-700 text-xl"
                      >
                        √ó
                      </button>
                    </div>
                    <div className="space-y-2">
                      {playerHistory.length > 0 ? (
                        playerHistory.map((entry, index) => (
                          <div key={index} className="border-l-4 border-blue-500 pl-3 py-2">
                            <div className="font-semibold">{entry.action}</div>
                            <div className="text-sm text-gray-600">
                              {entry.points > 0 ? '+' : ''}{entry.points} points
                            </div>
                            <div className="text-xs text-gray-500">
                              {entry.timestamp} ‚Ä¢ Total: {entry.new_total} pts
                              {entry.teacher_name && entry.teacher_name !== 'Anonyme' && (
                                <span> ‚Ä¢ Par: {entry.teacher_name}</span>
                              )}
                            </div>
                          </div>
                        ))
                      ) : (
                        <p className="text-gray-500 text-center">Aucun historique disponible</p>
                      )}
                    </div>
                  </div>
                </div>
              )}
            </>
          );
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
